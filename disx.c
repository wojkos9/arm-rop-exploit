#define _GNU_SOURCE
#include <elf.h>
#include <unistd.h>
#include <sys/mman.h>
#include <fcntl.h>

#define ST_INFO(b, t) (((b) << 4) | (t))

int main(int argc, char *argv[]) {
  char *path = argc > 1 ? argv[1] : "libheaptrack_inject.so";
  printf("path: %s\n", path);
  int f = open(path, O_RDWR);
  if (f == -1) {
    perror("open");
    return 1;
  }
  off_t sz = lseek(f, 0, SEEK_END);
  void *m = mmap(0, sz, PROT_READ | PROT_WRITE, MAP_SHARED, f, 0);
  if ((int)m == -1) {
    perror("mmap");
    return 1;
  }

  Elf32_Ehdr *e = m;
  Elf32_Phdr *p = m + e->e_phoff;
  Elf32_Dyn *dyn = 0;

  for (int i = 0; i < e->e_phnum; i++, p++) {
    if (p->p_flags | PF_X) {
      p->p_flags &= ~PF_X;
    }
    if (p->p_type == PT_DYNAMIC) {
      dyn = m + p->p_offset;
    }
  }

  Elf32_Sym *dsym = 0;
  int ndsym = 0;
  while (dyn->d_tag) {
    printf("%x\n", dyn->d_tag);
    if (dyn->d_tag == DT_SYMTAB) {
      dsym = m + dyn->d_un.d_val;
    } else if (dyn->d_tag == DT_HASH) {
      int *hasht = m + dyn->d_un.d_val;
      ndsym = hasht[1];
      printf("DSYM: %d\n", ndsym);
    }
    dyn++;
  }

  for (int i = 0; i < ndsym; i++) {
    if (dsym->st_name == 1) {
      // dsym->st_value = -0x223b4000 + 0x42a + 1;
      // dsym->st_value =   -0x22400000 - 0x18000 + 0x43a + 1; //0x54bfff000 - 0x76f5b000
      // dsym->st_value = 0x43472e8e - 0x434729ac + 0x3efdf9ad - 0x3e40b000; // 0 = 0x3e40b000 setuid = 0x3f70bedc fork = 0x3f70b1fc ret0 = 0x40003492
      // dsym->st_value = 0x43472e68 - 0x434729ac + 0x3efdf9ad - 0x3e40b000; // b *0x3efdfe94
      // dsym->st_value = 0x6e3b0 - 0x6e388 + 0x2000 + 0x3e1e1389 - 0x3e40b000; // b *0x3efdfe94
      dsym->st_value = -0x227c4f; // SLEEP
      // dsym->st_value = 0x0120e000 + 0x9b654; // ABORT
      // dsym->st_value = -0x38c7c4f; //0x0120e000 + 0x9b654; //0x12e7654;
      // prescanf 0x3efdfe94
      // ldmia 0x3efdff06
      dsym->st_info = ST_INFO(STB_GLOBAL, STT_NOTYPE);
      dsym->st_size = 0;
      dsym->st_shndx = SHN_ABS;
    }
    printf("%d: %x %d\n", i, dsym->st_shndx, dsym->st_name);
    dsym++;
  }


  // *(char *)m = 0x7f;
  return 0;
}
